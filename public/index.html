<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <link rel="preload" href="%PUBLIC_URL%/hero-forest-poster.jpg" as="image" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="å²©æ—æ ªå¼ä¼šç¤¾ - ä¸“ä¸šçš„ä¸­æ—¥è´¸æ˜“ç»¼åˆæœåŠ¡å•†" />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    
    <!-- SEOä¼˜åŒ– -->
    <meta name="keywords" content="å²©æ—æ ªå¼ä¼šç¤¾,ä¸­æ—¥è´¸æ˜“,ä¿å¥å“è¿›å£,å¤§å®—å•†å“å‡ºå£,IWABAYASHI Corporation" />
    <meta name="author" content="å²©æ—æ ªå¼ä¼šç¤¾" />
    <meta property="og:title" content="å²©æ—æ ªå¼ä¼šç¤¾ - ä¸“ä¸šçš„ä¸­æ—¥è´¸æ˜“ç»¼åˆæœåŠ¡å•†" />
    <meta property="og:description" content="è‡´åŠ›äºä¸­æ—¥åŒè¾¹è´¸æ˜“çš„ç»¼åˆæ€§è´¸æ˜“å…¬å¸ï¼Œä¸“ä¸šä»äº‹æ—¥æœ¬ä¿å¥å“è¿›å£ä»£ç†æœåŠ¡" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://steady-clafoutis-c30c37.netlify.app" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=%REACT_APP_GA_TRACKING_ID%"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '%REACT_APP_GA_TRACKING_ID%');
    </script>

    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <title>å²©æ—æ ªå¼ä¼šç¤¾ - ä¸“ä¸šçš„ä¸­æ—¥è´¸æ˜“ç»¼åˆæœåŠ¡å•†</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!-- ä¿®å¤åçš„ Netlify Identity é…ç½® -->
    <script>
      if (window.netlifyIdentity) {
        // åˆå§‹åŒ–å¤„ç†
        window.netlifyIdentity.on("init", user => {
          // å¤„ç†é‚€è¯·é“¾æ¥ - å¦‚æœURLä¸­åŒ…å«é‚€è¯·tokenï¼Œæ‰“å¼€æ³¨å†Œçª—å£
          if (window.location.hash.includes('invite_token')) {
            if (!user) {
              window.netlifyIdentity.open('signup');
            }
          }
          
          // å¤„ç†å¯†ç é‡ç½®é“¾æ¥
          if (window.location.hash.includes('recovery_token')) {
            window.netlifyIdentity.open('login');
          }
          
          // åªåœ¨éç™»å½•ç”¨æˆ·è®¿é—®æ—¶è®¾ç½®ç™»å½•åè·³è½¬
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              // æ£€æŸ¥æ˜¯å¦æ˜¯è¦è®¿é—® CMS ç®¡ç†é¡µé¢
              const shouldRedirectToCMS = 
                window.location.pathname.includes('/admin') || 
                window.location.search.includes('cms=true') ||
                sessionStorage.getItem('redirectToCMS') === 'true';
              
              if (shouldRedirectToCMS) {
                document.location.href = "/admin/";
              } else {
                // å¦‚æœä¸æ˜¯è¦è®¿é—®CMSï¼Œå°±åˆ·æ–°å½“å‰é¡µé¢
                window.location.reload();
              }
            });
          }
        });
        
        // æ·»åŠ ç®¡ç†å‘˜å·¥å…·æ ï¼ˆä»…å¯¹å·²ç™»å½•çš„ç®¡ç†å‘˜æ˜¾ç¤ºï¼‰
        window.netlifyIdentity.on("login", (user) => {
          setTimeout(() => {
            addAdminToolbar(user);
          }, 1000);
        });
        
        window.netlifyIdentity.on("logout", () => {
          removeAdminToolbar();
          // æ¸…é™¤CMSç›¸å…³çš„sessionStorage
          sessionStorage.removeItem('redirectToCMS');
          window.location.reload();
        });
      }
      
      // æ·»åŠ ç®¡ç†å‘˜å·¥å…·æ 
      function addAdminToolbar(user) {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å·¥å…·æ 
        if (document.getElementById('admin-toolbar')) return;
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç®¡ç†å‘˜æƒé™
        const userRoles = user.app_metadata?.roles || [];
        const isAdmin = userRoles.includes('admin') || userRoles.length === 0; // å¦‚æœæ²¡æœ‰è§’è‰²é™åˆ¶ï¼Œé»˜è®¤å…è®¸
        
        if (isAdmin && !window.location.pathname.includes('/admin')) {
          const toolbar = document.createElement('div');
          toolbar.id = 'admin-toolbar';
          toolbar.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(135deg, #1a4d32 0%, #2d5a3d 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
          `;
          
          toolbar.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px;">
              <span style="font-weight: 600;">ğŸ”§ ç®¡ç†å‘˜æ¨¡å¼</span>
              <span style="opacity: 0.8;">æ¬¢è¿ï¼Œ${user.user_metadata?.full_name || user.email}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <button onclick="goToCMS()" style="
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
              " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                ğŸ“ å†…å®¹ç®¡ç†
              </button>
              <button onclick="logoutAdmin()" style="
                background: #dc3545;
                border: none;
                color: white;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
              " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                ğŸšª é€€å‡º
              </button>
            </div>
          `;
          
          document.body.appendChild(toolbar);
          
          // è°ƒæ•´é¡µé¢å†…å®¹ï¼Œé¿å…è¢«å·¥å…·æ é®æŒ¡
          document.body.style.paddingTop = '50px';
        }
      }
      
      // ç§»é™¤ç®¡ç†å‘˜å·¥å…·æ 
      function removeAdminToolbar() {
        const toolbar = document.getElementById('admin-toolbar');
        if (toolbar) {
          toolbar.remove();
          document.body.style.paddingTop = '0';
        }
      }
      
      // å‰å¾€CMSç®¡ç†é¡µé¢
      function goToCMS() {
        sessionStorage.setItem('redirectToCMS', 'true');
        window.location.href = '/admin/';
      }
      
      // é€€å‡ºç®¡ç†å‘˜ç™»å½•
      function logoutAdmin() {
        if (window.netlifyIdentity) {
          window.netlifyIdentity.logout();
        }
      }
      
      // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç™»å½•çŠ¶æ€
      window.addEventListener('load', () => {
        if (window.netlifyIdentity) {
          const user = window.netlifyIdentity.currentUser();
          if (user) {
            addAdminToolbar(user);
          }
        }
      });
    </script>
  </body>
</html>